<nav id="site_nav" class="navbar navbar-expand-md navbar-light bg-faded{% if include.type %} {{ include.type }}{% endif %}">

  <button class="navbar-toggler navbar-toggler-right css-sensitive" type="button" data-toggle="collapse" data-target="#main_Nav" aria-controls="main_Nav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <a class="navbar-brand logo jump" href="/" title="Return to Home"><span class="sr-only css-sensitive">Return to Home</span>{% include images/letter.svg %}</a>

  <div class="collapse navbar-collapse" id="main_Nav">

    {% if page.app %}<a class="navbar-brand font-sensitive jump d-sm-none d-md-inline-block" href="{{ page.permalink }}" title="Reload Current {% if page.app %}App{% else %}Page{% endif %}">{{ page.title }}<span class="d-none d-lg-inline"> | {{ site.title }}</span><span class="sr-only">Current {% if page.app %}App{% else %}Page{% endif %}> - Click to {% if page.app %}Restart{% else %}Reload{% endif %}</span></a>{% endif %}

    <ul class="navbar-nav mr-auto css-sensitive">

      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="navAppsMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Apps</a>
        <div class="dropdown-menu" aria-labelledby="navAppsMenu">
          {% for group in site.data.menu %}{% assign group_title = group[1].name %}{% assign group_apps = group[1].apps %}{% assign apps = site.array %}{% for app_key in group_apps %}{% if jekyll.environment == site.debug or site.data.apps[app_key].published == true %}{% assign apps = apps | push: site.data.apps[app_key] %}{% endif %}{% endfor %}
            {% if apps.size > 0 %}<h5 class="dropdown-heading">{{ group_title }}</h5>
              {% for app in apps %}<a class="dropdown-item jump" href="{{ app.link }}" {% if app.ext %}target="_blank" rel="noopener" {% endif %}{% if app.desc %}data-toggle="tooltip" title="{{ app.desc | replace: '_', '' }}"{% if group == site.data.menu.first %} data-placement="bottom"{% endif %}{% endif %}>{{ app.name }}</a>{% endfor %}
            {% endif %}{% endfor %}
        </div>
      </li>

      {% assign menus = false %}{% if page.menu %}{% assign menus = page.menus %}{% elsif layout.menu %}{% assign menus = layout.menus %}{% elsif page.app and page.app != "" and site.data.apps[page.app].menus %}{% assign menus = site.data.apps[page.app].menus %}{% endif %}

      {% if menus and menus.size > 0 %}{% for menu in menus %}
      {% if menu.groups and menu.groups.size > 0 %}
        <li class="nav-item dropdown"{%if menu.desc %} title="{{ menu.desc | replace: '_', '' }}"{% endif %}>
          <a class="nav-link dropdown-toggle" href="#" id="navMenu_{{ menu.name }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            {% if menu.short_name %}<span class="d-inline d-lg-none">{{ menu.short_name }}</span><span class="d-none d-lg-inline">{{ menu.name }}</span>{% else %}{{ menu.name }}{% endif %}
          </a>
          <div class="dropdown-menu" aria-labelledby="navMenu_{{ menu.name }}">

            {% for group in menu.groups %}{% assign group_commands = group[1].commands %}

            {% if group[1].name %}<h5 class="dropdown-heading">{{ group[1].name }}</h5>{% endif %}

            {% for command in group_commands %}
            <a {% if command.id %}id="{{command.id}}"{% endif %} class="dropdown-item{% if command.url %} jump{% endif %}{% if command.disabled_until and command.disabled_until.size > 0%} disabled{% for until in command.disabled_until %} state-{{until}}{% endfor %}{% endif %}" href="{% if command.hash %}#{% if command.auth %}{{ command.auth }}{% if command.scope %}|{{ command.scope }}{% endif %},{% endif %}{{ command.hash }}{% else %}{{ command.url }}{% endif %}" {% if command.desc %}data-toggle="tooltip" title="{{ command.desc }}"{% if group == menu.groups.first %}{% if command == group_commands.first %} data-placement="bottom"{% endif %}{% endif %}{% endif %}{% if command.imports and command.imports.size > 0 %}{% capture command_imports %}[{% for import in command.imports %}{% if jekyll.environment == site.debug %}{% for import_url in site.data.imports[import].dev %} { id: '{{ import_url.id }}', url : '{{ import_url.url }}'{% if import_url.mode %}, mode : '{{ import_url.mode }}'{% endif %}{% if import_url.map %}, map : {{ import_url.map }}{% endif %}{% if import_url.overrides %}, overrides : {{ import_url.overrides | jsonify }}{% endif %} },{% endfor %}{% else %}{% for import_url in site.data.imports[import].prod %} { id: '{{ import_url.id }}', url : '{{ import_url.url }}'{% if import_url.mode %}, mode : '{{ import_url.mode }}'{% endif %}{% if import_url.map %}, map : {{ import_url.map }}{% endif %}{% if import_url.overrides %}, overrides : {{ import_url.overrides | jsonify }}{% endif %} },{% endfor %}{% endif %}{% endfor %}]{% endcapture %} onclick="event.preventDefault(); {{ site.app.namespace }}.Controller.load({{ command_imports | replace: '"', "'" }}).then(() => {window.location.hash = '#{% if command.auth %}{{ command.auth }}{% if command.scope %}|{{ command.scope }}{% endif %},{% endif %}{{ command.hash }}';}).catch(e => {console.error(e);});"{% endif %}>
              {{ command.name }}{% if command.desc %}<span class="sr-only">{{ command.desc }}</span>{% endif %}
            </a>
            {% if command.divider %}<div class="dropdown-divider"></div>{% endif %}

            {% endfor %}

            {% endfor %}

          </div>
        </li>
      {% elsif menu.hash %}
        <li class="nav-item">
          <a class="nav-link" href="#{{ menu.hash }}"{% if menu.desc %}data-toggle="tooltip" data-placement="bottom" title="{{ menu.desc }}"{% endif %}>
            {% if menu.short_name %}<span class="d-inline d-lg-none">{{ menu.short_name }}</span><span class="d-none d-lg-inline">{{ menu.name }}</span>{% else %}{{ menu.name }}{% endif %}
          </a>
        </li>
      {% endif %}
      {% endfor %}{% else %}
        <li class="nav-item">
          <a class="nav-link jump" href="/changes/" data-toggle="tooltip" data-placement="bottom" title="What is new across this site, and with individual apps">Changes<span class="sr-only">What is new across this site, and with individual apps</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link jump" href="/support/" data-toggle="tooltip" data-placement="bottom" title="Get access to high-quality support, and help us to deliver high quality tools">Support<span class="sr-only">Get access to high-quality support, and help us to deliver high quality tools</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link jump" href="/about/" data-toggle="tooltip" data-placement="bottom" title="Find out more about this site, our privacy safeguards and our technology">About<span class="sr-only">Click to find out more about this site, our privacy safeguards and our technology</span></a>
        </li>{% endif %}

    </ul>

    {% if page.app or page.login %}
      <form id="sign_out" class="form-inline mt-2 mt-md-0" style="display: none;">
        <span class="navbar-text mr-2">Signed in as <a id="user_details" class="navbar-link username" target="_blank" href="https://security.google.com/settings/security/permissions" rel="noopener" data-toggle="tooltip" data-placement="bottom"></a></span>
        <a class="btn btn-outline-success my-2 my-sm-0 btn-outline-action" href="#">Sign Out</a>
      </form>

      <form id="sign_in" class="form-inline mt-2 mt-md-0" style="display: none;">
        <a class="btn btn-outline-success my-2 my-sm-0 btn-outline-action" href="#">Sign In</a>
      </form>
    {% endif %}

  </div>

</nav>